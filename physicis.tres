[gd_resource type="ShaderMaterial" load_steps=2 format=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

uniform vec2 screen_size;   // just for distance attenuation
uniform vec2 body_pos0;     // in pixels
uniform vec2 body_vel0;     // in pixels/sec
uniform int body_count;
uniform vec2 rect_pos;
uniform vec2 obs_pos;
uniform vec2 obs_direction;

uniform float c;
const float base_wavelength = 550.0;

vec3 wavelength_to_rgb(float wavelength){
    float r=0.0; float g=0.0; float b=0.0;
    if(wavelength>=380.0 && wavelength<=440.0){ r=-(wavelength-440.0)/60.0; b=1.0; }
    else if(wavelength>=440.0 && wavelength<=490.0){ g=(wavelength-440.0)/50.0; b=1.0; }
    else if(wavelength>=490.0 && wavelength<=510.0){ g=1.0; b=-(wavelength-510.0)/20.0; }
    else if(wavelength>=510.0 && wavelength<=580.0){ r=(wavelength-510.0)/70.0; g=1.0; }
    else if(wavelength>=580.0 && wavelength<=645.0){ r=1.0; g=-(wavelength-645.0)/65.0; }
    else if(wavelength>=645.0 && wavelength<=780.0){ r=1.0; }

    float intensity=1.0;
    if(wavelength>700.0) intensity=0.3+0.7*(780.0-wavelength)/80.0;
    else if(wavelength<420.0) intensity=0.3+0.7*(wavelength-380.0)/40.0;

    r*=intensity; g*=intensity; b*=intensity;
    return vec3(r,g,b);
}

void fragment(){
    vec2 frag_pos = vec2(FRAGCOORD.x, screen_size.y - (FRAGCOORD.y - rect_pos.y));

    vec3 final_color = vec3(0.0);

    if(body_count > 0){
        vec2 dir0 = frag_pos - body_pos0; // no flip
        float dist0 = length(dir0);
        dist0 -= 20.0; // radius
        if(dist0 > 0.0) {
			
             float v_radial0 = dot(normalize(dir0), body_vel0);
             float wl0 = base_wavelength * sqrt((1.0 - v_radial0/c) / (1.0 + v_radial0/c));
			vec2 n = normalize(dir0);
			vec2 v = normalize(body_vel0);
			
             final_color = wavelength_to_rgb(wl0) / (0.01*dist0*dist0);
			float cos_theta = dot(-n, v);
			float beta = length(body_vel0) / c;
			float cone = smoothstep(beta - 0.05, beta + 0.05, cos_theta);
			final_color *= (cone+1.0)*0.5;
        }

        
    }

    COLOR = vec4(final_color,1.0);
}

"

[resource]
shader = SubResource( 1 )
shader_param/screen_size = null
shader_param/body_pos0 = null
shader_param/body_vel0 = null
shader_param/body_count = null
shader_param/rect_pos = null
shader_param/obs_pos = null
shader_param/obs_direction = null
shader_param/c = null
